blueprint:
  name: Zone Occupation
  author: Colorful Cookie
  description: Simple zone occupation boolean switcher automation
  domain: automation
  input:
    person:
      name: Person
      description: The is the persons who's location is going to be used for the control.
      selector:
        entity:
          filter:
            - domain:
                - person
          multiple: true
    zone:
      name: Zone
      description:
        This zone will be used together with the persons to decide weather
        a thermostat should be on or off.
      selector:
        entity:
          filter:
            - domain:
                - zone
          multiple: false
    zome_occupied_boolean:
      name: Input Boolean Occupied
      description:
        An input boolean that should changes its state based on the occupation
        of the zone from above.
      selector:
        entity:
          filter:
            - domain:
                - input_boolean
          multiple: false
  source_url: https://github.com/ColorfulCookie/HAT/blob/main/zone-occupation-boolean-control.yaml
trigger_variables:
  person: !input person
  zone: !input zone
  zome_occupied_boolean: !input zome_occupied_boolean
trigger:
  - platform: zone
    entity_id: !input person
    zone: !input zone
    event: enter
    id: enter
  - platform: zone
    entity_id: !input person
    zone: !input zone
    event: leave
    id: leave
  - platform: state
    entity_id: !input person
    from: null
    to: null
    id: state-change
variables:
  person: !input person
  zone: !input zone
  zome_occupied_boolean: !input zome_occupied_boolean
  zone_occupation: "{% set tmp = false %}
    {% for p in person %}
    {% if p in state_attr(zone, 'persons') %}
    {% set tmp = 1 %}
    {% break %}
    {% endif %}
    {% endfor %}
    {{ tmp }}"
condition:
action:
  - if:
      - condition: trigger
        id: hat-start
    then:
      - delay:
          seconds: 30
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ zone_occupation > 0 }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: !input zome_occupied_boolean
    default:
      - service: input_boolean.turn_off
        target:
          entity_id: !input zome_occupied_boolean
